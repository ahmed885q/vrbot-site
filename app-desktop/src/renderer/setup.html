<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>First Run Setup</title>
  <style>
    body{margin:0;font-family:system-ui;background:#0b1020;color:#e6ecff;display:flex;align-items:center;justify-content:center;height:100vh}
    .card{width:min(760px,92vw);background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
    h1{margin:0 0 8px;font-size:18px}
    .muted{color:rgba(230,236,255,.7);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    input{flex:1;min-width:260px;background:#1c264d;border:1px solid rgba(255,255,255,.08);color:#e6ecff;padding:10px;border-radius:10px}
    button{background:#2b6cff;color:white;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,.08)}
    .bar{height:10px;background:rgba(255,255,255,.07);border-radius:999px;overflow:hidden;margin-top:12px}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#2b6cff,#00ffbe)}
    pre{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;max-height:220px;overflow:auto;font-size:12px;margin-top:12px}
    .label{font-size:12px;color:rgba(230,236,255,.75)}
  </style>
</head>
<body>
  <div class="card">
    <h1>تهيئة أول مرة</h1>
    <div class="muted">سيتم تنزيل الأدوات المطلوبة تلقائياً (FFmpeg + MediaMTX) ثم يبدأ البرنامج بالعمل.</div>

    <div class="row">
      <div class="label">FFmpeg URL</div>
      <input id="ffUrl" />
    </div>

    <div class="row">
      <div class="label">MediaMTX URL</div>
      <input id="mtxUrl" />
    </div>

    <div class="row">
      <button id="btnGo" onclick="start()">ابدأ التهيئة</button>
      <button class="ghost" onclick="window.VR.openFolder()">فتح مجلد الأدوات</button>
    </div>

    <div class="bar"><div id="fill" class="fill"></div></div>
    <div class="muted" id="status" style="margin-top:8px">جاهز</div>

    <pre id="log"></pre>
  </div>

<script>
  const fill = document.getElementById('fill');
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const btnGo = document.getElementById('btnGo');

  let defaults = {
    ffSha256:"", mtxSha256:"",
    tesseractSha256:"",
    tessEngSha256:"",
    tessAraSha256:"",
    tesseractUrl:"",
    tessEngUrl:"",
    tessAraUrl:""
  };

  function log(s){
    logEl.textContent += `[${new Date().toLocaleTimeString()}] ${s}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setProgress(p){ fill.style.width = Math.max(0, Math.min(100, p)) + '%'; }

  async function start(){
    btnGo.disabled = true;
    setProgress(1);
    statusEl.textContent = "بدء التهيئة...";
    log("Setup started");

    const ffUrl = document.getElementById("ffUrl").value.trim();
    const mtxUrl = document.getElementById("mtxUrl").value.trim();

    try{
      const r = await window.VR.setupStart({
        ffUrl,
        mtxUrl,
        ffSha256: defaults.ffSha256,
        mtxSha256: defaults.mtxSha256,

        tesseractUrl: defaults.tesseractUrl,
        tesseractSha256: defaults.tesseractSha256,

        tessEngUrl: defaults.tessEngUrl,
        tessEngSha256: defaults.tessEngSha256,
        tessAraUrl: defaults.tessAraUrl,
        tessAraSha256: defaults.tessAraSha256
      });
      log(JSON.stringify(r));
    }catch(e){
      log("ERROR: " + (e?.message || e));
      statusEl.textContent = "فشل التهيئة";
      btnGo.disabled = false;
    }
  }

  window.VR.onSetupDefaults((d)=>{
    if (d?.ffUrl) document.getElementById("ffUrl").value = d.ffUrl;
    if (d?.mtxUrl) document.getElementById("mtxUrl").value = d.mtxUrl;

    defaults.ffSha256 = d?.ffSha256 || "";
    defaults.mtxSha256 = d?.mtxSha256 || "";

    defaults.tesseractUrl = d?.tesseractUrl || "";
    defaults.tesseractSha256 = d?.tesseractSha256 || "";

    defaults.tessEngUrl = d?.tessEngUrl || "";
    defaults.tessEngSha256 = d?.tessEngSha256 || "";
    defaults.tessAraUrl = d?.tessAraUrl || "";
    defaults.tessAraSha256 = d?.tessAraSha256 || "";

    log("Loaded remote-config defaults ✅");
  });

  window.VR.onSetupStatus((s)=>{ statusEl.textContent = s; log(s); });
  window.VR.onSetupProgress((p)=>{ setProgress(p.percent); if (p.detail) log(p.detail); });
  window.VR.onSetupDone((ok)=>{
    if(ok){ statusEl.textContent = "تمت التهيئة ✅ سيتم فتح الداشبورد"; setProgress(100); }
    else{ statusEl.textContent = "فشل التهيئة"; btnGo.disabled = false; }
  });
</script>
</body>
</html>
