'use client'

import { useState, useEffect } from 'react'
import { useParams } from 'next/navigation'
import { Badge, Card, Button, Row } from '@/components/bot/ui'
import { windowsAgentService } from '@/modules/viking-rise/services/WindowsAgentService'

export default function BotDetailPage() {
  const params = useParams()
  const botId = params.id as string
  
  const [bot, setBot] = useState<any>(null)
  const [loading, setLoading] = useState(true)
  const [stats, setStats] = useState({
    actionsToday: 0,
    successRate: 0,
    avgDuration: 0,
    lastActions: [] as any[]
  })

  useEffect(() => {
    loadBotData()
    const interval = setInterval(loadBotData, 5000)
    return () => clearInterval(interval)
  }, [botId])

  const loadBotData = async () => {
    setLoading(true)
    try {
      const bots = await windowsAgentService.getBots()
      const foundBot = bots.find(b => b.id === botId)
      setBot(foundBot)
      
      // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      setStats({
        actionsToday: foundBot?.totalActions || 0,
        successRate: foundBot?.successRate * 100 || 0,
        avgDuration: 2450,
        lastActions: [
          { time: '10:30', action: 'ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¹', success: true },
          { time: '10:15', action: 'Ø¥Ø±Ø³Ø§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø§Øª', success: true },
          { time: '09:45', action: 'Ø¬Ù…Ø¹ Ù…ÙˆØ§Ø±Ø¯', success: false },
          { time: '09:30', action: 'ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¹', success: true },
        ]
      })
    } catch (error) {
      console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª:', error)
    } finally {
      setLoading(false)
    }
  }

  const executeTask = async (taskType: 'shield' | 'helps' | 'collection') => {
    try {
      await windowsAgentService.executeBotTask(botId, taskType)
      await loadBotData()
    } catch (error) {
      console.error('ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø©:', error)
    }
  }

  if (loading) {
    return (
      <div style={{ padding: 40, textAlign: 'center' }}>
        <div style={{ fontSize: 48, marginBottom: 20 }}>â³</div>
        <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª...</h3>
      </div>
    )
  }

  if (!bot) {
    return (
      <div style={{ padding: 40, textAlign: 'center' }}>
        <div style={{ fontSize: 48, marginBottom: 20 }}>âŒ</div>
        <h3>Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h3>
        <p>ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
      </div>
    )
  }

  return (
    <div style={{ padding: 20, maxWidth: 1000, margin: '0 auto' }}>
      {/* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 20,
        padding: 20,
        borderRadius: 16,
        background: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
        color: 'white'
      }}>
        <div>
          <h1 style={{ margin: 0, fontSize: 24, fontWeight: 900 }}>ğŸ¤– {bot.name}</h1>
          <p style={{ margin: '8px 0 0 0', opacity: 0.9 }}>
            {bot.gameAccount} â€¢ {bot.windowTitle}
          </p>
        </div>
        
        <div style={{ display: 'flex', gap: 10 }}>
          <Badge 
            label={bot.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
            icon={bot.status === 'active' ? 'âœ…' : 'â¸ï¸'}
            bg={bot.status === 'active' ? '#dcfce7' : '#f3f4f6'}
            color={bot.status === 'active' ? '#166534' : '#6b7280'}
          />
          <Badge 
            label={`${stats.actionsToday} Ø¥Ø¬Ø±Ø§Ø¡`}
            icon="ğŸ“Š"
            bg="#dbeafe"
            color="#1e40af"
          />
        </div>
      </div>

      {/* Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */}
      <Card title="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©" subtitle="ØªÙ†ÙÙŠØ° Ù…Ù‡Ø§Ù… ÙÙˆØ±ÙŠØ© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª">
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: 10 }}>
          <Button 
            onClick={() => executeTask('shield')}
            disabled={bot.status !== 'active'}
          >
            ğŸ›¡ï¸ ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¹
          </Button>
          
          <Button 
            onClick={() => executeTask('helps')}
            disabled={bot.status !== 'active'}
          >
            ğŸ¤ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø§Øª
          </Button>
          
          <Button 
            onClick={() => executeTask('collection')}
            disabled={bot.status !== 'active'}
          >
            ğŸ“¦ Ø¬Ù…Ø¹ Ù…ÙˆØ§Ø±Ø¯
          </Button>
          
          <Button 
            onClick={() => window.history.back()}
            variant="ghost"
          >
            â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©
          </Button>
        </div>
      </Card>

      {/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 15, marginTop: 20 }}>
        <Card title="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…">
          <div style={{ fontSize: 32, fontWeight: 900, textAlign: 'center' }}>{stats.actionsToday}</div>
        </Card>
        
        <Card title="Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­">
          <div style={{ fontSize: 32, fontWeight: 900, textAlign: 'center', color: stats.successRate > 80 ? '#10b981' : '#f59e0b' }}>
            {stats.successRate.toFixed(1)}%
          </div>
        </Card>
        
        <Card title="Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ø©">
          <div style={{ fontSize: 32, fontWeight: 900, textAlign: 'center' }}>{(stats.avgDuration / 1000).toFixed(1)}s</div>
        </Card>
        
        <Card title="Ø§Ù„Ø­Ø§Ù„Ø©">
          <div style={{ fontSize: 32, fontWeight: 900, textAlign: 'center' }}>
            {bot.status === 'active' ? 'ğŸŸ¢' : 'ğŸ”´'}
          </div>
        </Card>
      </div>

      {/* Ø¢Ø®Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */}
      <Card title="Ø¢Ø®Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" subtitle="Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ù†Ø´Ø§Ø·Ø§Øª" style={{ marginTop: 20 }}>
        <div style={{ display: 'grid', gap: 10 }}>
          {stats.lastActions.map((action, index) => (
            <div key={index} style={{
              padding: 12,
              borderRadius: 8,
              background: '#f8fafc',
              border: '1px solid #e5e7eb',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <div style={{
                  width: 32,
                  height: 32,
                  borderRadius: '50%',
                  background: action.success ? '#dcfce7' : '#fee2e2',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  {action.success ? 'âœ…' : 'âŒ'}
                </div>
                <div>
                  <div style={{ fontWeight: 900 }}>{action.action}</div>
                  <div style={{ color: '#6b7280', fontSize: 12 }}>{action.time}</div>
                </div>
              </div>
              
              <Badge 
                label={action.success ? 'Ù†Ø§Ø¬Ø­' : 'ÙØ§Ø´Ù„'}
                bg={action.success ? '#dcfce7' : '#fee2e2'}
                color={action.success ? '#166534' : '#991b1b'}
              />
            </div>
          ))}
        </div>
      </Card>

      {/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª */}
      <Card title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª" subtitle="ØªØ®ØµÙŠØµ Ø³Ù„ÙˆÙƒ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª" style={{ marginTop: 20 }}>
        <div style={{ display: 'grid', gap: 15 }}>
          <Row left="Ø§Ø³Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©" right={<code>{bot.windowTitle}</code>} />
          <Row left="Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²" right={bot.deviceId} />
          <Row left="Ø­Ø³Ø§Ø¨ Ø§Ù„Ù„Ø¹Ø¨Ø©" right={bot.gameAccount} />
          <Row left="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡" right={new Date(bot.createdAt || Date.now()).toLocaleDateString('ar-SA')} />
          <Row left="Ø¢Ø®Ø± Ù†Ø´Ø§Ø·" right={bot.lastActive ? new Date(bot.lastActive).toLocaleTimeString('ar-SA') : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'} />
        </div>
        
        <div style={{ marginTop: 20, display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 10 }}>
          <Button variant="ghost">
            âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          </Button>
          
          <Button variant="ghost">
            ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
          </Button>
          
          <Button variant="danger">
            ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙˆØª
          </Button>
        </div>
      </Card>
    </div>
  )
}