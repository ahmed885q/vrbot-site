"use strict";(()=>{var e={};e.id=2757,e.ids=[2757],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},480:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>g,originalPathname:()=>f,patchFetch:()=>k,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>b,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>v});var s={};t.r(s),t.d(s,{POST:()=>l,runtime:()=>c});var o=t(95419),i=t(69108),n=t(99678),a=t(78070),u=t(28291),p=t(51010);let c="nodejs",d=new u.Z(process.env.STRIPE_SECRET_KEY);async function l(e){let r;let t=e.headers.get("stripe-signature"),s=process.env.STRIPE_WEBHOOK_SECRET;if(!t||!s)return a.Z.json({error:"Missing stripe signature/secret"},{status:400});let o=await e.text();try{r=d.webhooks.constructEvent(o,t,s)}catch(e){return console.error("Webhook signature failed:",e?.message),a.Z.json({error:`Invalid signature: ${e?.message||"unknown"}`},{status:400})}try{if("customer.subscription.created"===r.type||"customer.subscription.updated"===r.type||"customer.subscription.deleted"===r.type){let e=r.data.object,t=e.id,s="string"==typeof e.customer?e.customer:e.customer?.id??null,o=e.status??null,i=e.items?.data?.[0]?.price?.id??null,n="number"==typeof e.current_period_end?new Date(1e3*e.current_period_end).toISOString():null,u=e.metadata?.userId;if(!u)return console.warn("No userId in subscription metadata",{subscriptionId:t,customerId:s}),a.Z.json({ok:!0,note:"missing userId metadata"});let{error:c}=await p.p.from("subscriptions").upsert({user_id:u,plan:"active"===o||"trialing"===o?"pro":"free",status:o,stripe_customer_id:s,stripe_subscription_id:t,price_id:i,current_period_end:n},{onConflict:"user_id"});if(c)return console.error("Supabase upsert error:",c),a.Z.json({error:`Supabase: ${c.message}`},{status:500})}return a.Z.json({received:!0})}catch(e){return console.error("Webhook handler error:",e),a.Z.json({error:e?.message||"Webhook failed"},{status:500})}}let h=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/workspaces/vrbot-site/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:_,serverHooks:b,headerHooks:g,staticGenerationBailout:v}=h,f="/api/stripe/webhook/route";function k(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:_})}},51010:(e,r,t)=>{t.d(r,{p:()=>s});let s=(0,t(23950).eI)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[1638,6206,3950,8291],()=>t(480));module.exports=s})();