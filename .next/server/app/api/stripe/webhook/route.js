"use strict";(()=>{var e={};e.id=2757,e.ids=[2757],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},3837:e=>{e.exports=require("util")},480:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>v,originalPathname:()=>E,patchFetch:()=>f,requestAsyncStorage:()=>_,routeModule:()=>h,serverHooks:()=>b,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>k});var o={};t.r(o),t.d(o,{POST:()=>l,runtime:()=>c});var s=t(5419),i=t(9108),n=t(9678),u=t(8070),a=t(8291),p=t(1010);let c="nodejs",d=new a.Z(process.env.STRIPE_SECRET_KEY);async function l(e){let r;let t=e.headers.get("stripe-signature"),o=process.env.STRIPE_WEBHOOK_SECRET;if(!t||!o)return u.Z.json({error:"Missing signature"},{status:400});let s=await e.text();try{r=d.webhooks.constructEvent(s,t,o)}catch(e){return console.error("Webhook signature failed:",e.message),u.Z.json({error:"Invalid signature"},{status:400})}try{if("customer.subscription.created"===r.type||"customer.subscription.updated"===r.type){let e=r.data.object,t="string"==typeof e.customer?e.customer:e.customer.id,o=e.id,s=e.status,i=e.items.data[0]?.price?.id??null,n="number"==typeof e.current_period_end?new Date(1e3*e.current_period_end).toISOString():null,a=e.metadata?.userId;if(!a)return console.warn("No userId in subscription metadata"),u.Z.json({ok:!0});await p.p.from("subscriptions").upsert({user_id:a,stripe_customer_id:t,stripe_subscription_id:o,status:s,price_id:i,current_period_end:n},{onConflict:"user_id"})}return u.Z.json({received:!0})}catch(e){return console.error("Webhook handler error:",e),u.Z.json({error:"Webhook failed"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/workspaces/vrbot-site/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:b,headerHooks:v,staticGenerationBailout:k}=h,E="/api/stripe/webhook/route";function f(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:m})}},1010:(e,r,t)=>{t.d(r,{p:()=>o});let o=(0,t(3950).eI)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,3950,8291],()=>t(480));module.exports=o})();