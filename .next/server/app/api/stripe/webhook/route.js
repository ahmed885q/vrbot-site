"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},3837:e=>{e.exports=require("util")},480:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>E,patchFetch:()=>S,requestAsyncStorage:()=>k,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>y});var s={};r.r(s),r.d(s,{POST:()=>f,dynamic:()=>p});var i=r(5419),o=r(9108),a=r(9678),n=r(8070),u=r(8291),c=r(3950);let p="force-dynamic",d=new u.Z(process.env.STRIPE_SECRET_KEY),l=(0,c.eI)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}});async function _(e){let{error:t}=await l.from("stripe_events").insert({id:e});return t?String(t.message).toLowerCase().includes("duplicate")?{ok:!1,duplicate:!0}:{ok:!1,duplicate:!1,error:t}:{ok:!0}}async function m(e){let t={user_id:e.userId,plan:e.plan??"pro",status:e.status??null,stripe_customer_id:e.stripe_customer_id??null,stripe_subscription_id:e.stripe_subscription_id??null,current_period_end:e.current_period_end??null,cancel_at_period_end:e.cancel_at_period_end??!1},{error:r}=await l.from("subscriptions").upsert(t,{onConflict:"user_id"});if(r)throw r}async function b(e){let{data:t,error:r}=await l.from("subscriptions").select("user_id").eq("stripe_customer_id",e).maybeSingle();if(r)throw r;return t?.user_id??null}async function f(e){let t;let r=e.headers.get("stripe-signature"),s=process.env.STRIPE_WEBHOOK_SECRET;if(!r||!s)return n.Z.json({error:"Missing webhook signature/secret"},{status:400});let i=await e.text();try{t=d.webhooks.constructEvent(i,r,s)}catch(e){return n.Z.json({error:`Webhook Error: ${e.message}`},{status:400})}let o=await _(t.id);if(!o.ok&&o.duplicate)return n.Z.json({received:!0,duplicate:!0});if(!o.ok&&!o.duplicate)return n.Z.json({error:"Failed idempotency insert"},{status:500});try{switch(t.type){case"checkout.session.completed":{let e=t.data.object,r=e.client_reference_id||e.metadata?.userId,s="string"==typeof e.customer?e.customer:e.customer?.id,i="string"==typeof e.subscription?e.subscription:e.subscription?.id;if(!r)break;await m({userId:r,plan:"pro",status:"active",stripe_customer_id:s??null,stripe_subscription_id:i??null});break}case"customer.subscription.updated":case"customer.subscription.deleted":{var a;let e=t.data.object,r="string"==typeof e.customer?e.customer:e.customer?.id;if(!r)break;let s=await b(r);if(!s)break;let i=e.status,o=(a=e.current_period_end??null)?new Date(1e3*a).toISOString():null,n=!!e.cancel_at_period_end,u="active"===i||"trialing"===i;await m({userId:s,plan:u?"pro":"free",status:i,stripe_customer_id:r,stripe_subscription_id:e.id,current_period_end:o,cancel_at_period_end:n});break}case"invoice.payment_succeeded":{let e=t.data.object,r="string"==typeof e.customer?e.customer:e.customer?.id;if(!r)break;let s=await b(r);if(!s)break;await m({userId:s,plan:"pro",status:"active",stripe_customer_id:r});break}case"invoice.payment_failed":{let e=t.data.object,r="string"==typeof e.customer?e.customer:e.customer?.id;if(!r)break;let s=await b(r);if(!s)break;await m({userId:s,plan:"free",status:"past_due",stripe_customer_id:r})}}return n.Z.json({received:!0})}catch(e){return n.Z.json({error:e.message??"Webhook handler failed"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/workspaces/vrbot-site/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:k,staticGenerationAsyncStorage:w,serverHooks:v,headerHooks:g,staticGenerationBailout:y}=h,E="/api/stripe/webhook/route";function S(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:w})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,206,950,291],()=>r(480));module.exports=s})();